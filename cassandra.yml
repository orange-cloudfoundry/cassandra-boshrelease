---
name: cassandra1111_d_omi_v5

instance_groups:
  - name: cassandra-seeds
    instances: 3
    jobs:
      - name: cassandra
        release: *cassandra_release
        provides:
          seeds: { as: &cassandra_seeds_link cassandra_seeds_list }
        consumes:
          seeds: { from: *cassandra_seeds_link }
        properties: &cassandra_properties
            cluster_name: &cassandra_cluster_name omi_cluster
            num_tokens: 256
            server_encryption:
              internode_encryption: none
            client_encryption_options:
              enabled: false
              optional: true
              require_client_auth: true
            max_heap_size: 6G
            heap_newsize: 800M
            cass_pwd: ((cassandra_admin_password))
            cassandra_ssl_YN: N
            validate_ssl_TF: false
            cassDbCertificate:
              ca: ((cassandra_certificate_seed.ca))
              private_key: ((cassandra_certificate_seed.private_key))
              certificate: ((cassandra_certificate_seed.certificate))
            cert:
              ca: ((cassandra_certificate_seed))
              private_key: ((cassandra_certificate_seed.private_key))
              certificate: ((cassandra_certificate_seed.certificate))
            cass_KSP: ((cassandra_key_store_pass))
            cass_version: 3.11.1
            cass_upgrade_TF: false
            JMX_PORT: 7199
            LOCAL_JMX_YN: yes
            topology:
              - 10.165.0.92=DC1:RAC1
              - 10.165.0.93=DC1:RAC1
              - 10.165.0.94=DC1:RAC1
              - 10.165.0.95=DC1:RAC1
    stemcell: *trusty_stemcell
    vm_type: large
    persistent_disk_type: stoblok_cass
    env:
      persistent_disk_fs: xfs
      bosh: { swap_size: 0 }
    networks:
      - name: &cassandra_network tf-net-cassandra

  - name: cassandra-servers
    instances: 1
    jobs:
      - name: cassandra
        release: *cassandra_release
        consumes:
          seeds: { from: *cassandra_seeds_link }
        properties:  *cassandra_properties
    stemcell: *trusty_stemcell
    vm_type: large
    persistent_disk_type: stoblok_cass
    env:
      persistent_disk_fs: xfs
      bosh: { swap_size: 0 }
    networks:
      - name: *cassandra_network

  - name: cassandra-open-service-broker
    instances: 0
    jobs:
    - name: broker
      release: *cassandra_release
      consumes:
        seeds: { from: *cassandra_seeds_link }
      properties:
        broker:
          password: NankUnliUspUcWosliawmikBekibko
          user: cassandra-broker
        cassandra_seed:
          admin_password: ((cassandra_admin_password))
    - name: route-registrar
      properties:
        route_registrar:
          external_host: cassandra-broker3.nd-preprod-ops-paas.itn.intraorange
          health_checker:
            interval: 10
            name: healthchk
          message_bus_servers:
          - host: 192.168.26.3:4222
            password: rhyb4Twauvsu
            user: nats
          port: 8080
      release: *route-registrar
    stemcell: *trusty_stemcell
    vm_type: large
    persistent_disk_type: stoblok_cass
    env:
      persistent_disk_fs: xfs
      bosh: { swap_size: 0 }
    networks:
      - name: *cassandra_network


update:
  serial: true # instance groups to be deployed sequentially.
  canaries: 1
  canary_watch_time: 30000-240000
  max_in_flight: 1
  update_watch_time: 30000-240000


releases:
  - name: &cassandra_release cassandra_r_v5
    version: latest
  - name: &route-registrar route-registrar
    version: latest
stemcells:
  - alias: &trusty_stemcell trusty
    os: ubuntu-trusty
    version: latest


variables:
  - name: cassandra_admin_password
    type: password
  - name: /internalCA
    type: certificate
    options:
      is_ca: true
      common_name: internalCA
  - name: cassandra_certificate_seed
    type: certificate
    options:
      ca: /internalCA
      common_name: <%= seed.instance.address %>
      alternative_names: 
        - "*.cassandra-seeds.cassandra-net.cassandra.bosh"
      extended_key_usage: [ client_auth, server_auth ]
  - name: cassandra_certificate_injector
    type: certificate
    options:
      ca: /internalCA
      common_name: <%= injector.instance.address %>
      alternative_names: 
        - "*.cassandra-injectors.cassandra-net.cassandra.bosh"
      extended_key_usage: [ client_auth, server_auth ]
  - name: cassandra_certificate_cluster
    type: certificate
    options:
      ca: /internalCA
      common_name: <%= cluster.instance.address %>
      alternative_names: 
        - "*.cassandra-servers.cassandra-net.cassandra.bosh"
      extended_key_usage: [ client_auth, server_auth ]
  - name: cassandra_key_store_pass  
    type: password

