---
name:  acc-tests

releases:
  - name: &cassandra_release cassandra-acc-tests
    version: latest

instance_groups:
  - name: cassandra-seeds
    instances: 1
    azs: [z1]
    jobs:
      - name: cassandra
        release: *cassandra_release
        provides:
          cassandra: { as: &cassandra_seeds_link cassandra_seeds_list }
        consumes:
          seeds: { from: *cassandra_seeds_link }
        properties: &cassandra_properties
          cluster_name: &cassandra_cluster_name cluster
          system_auth_keyspace_replication_factor: 3
          number_of_non_seeds_nodes: &number_of_non_seeds_nodes 2
          num_tokens: 256
         # internode_encryption_mode: none
         # client_encryption:
          #  enabled: true
          #  require_client_auth: true
          max_heap_size: 6G
          heap_newsize: 800M
          cass_pwd: ((cassandra_admin_password))
       #   validate_ssl_TF: false
          cassDbCertificate:
            ca: ((cassandra_certificate_seeds.ca))
            private_key: ((cassandra_certificate_seeds.private_key))
            certificate: ((cassandra_certificate_seeds.certificate))
          cert:
            ca: ((cassandra_certificate_seeds))
            private_key: ((cassandra_certificate_seeds.private_key))
            certificate: ((cassandra_certificate_seeds.certificate))
          cass_KSP: ((cassandra_key_store_pass))
          cass_version: 3.11.1
          cass_upgrade_TF: false
          topology:
            # Don't bother these values, as they are not used yet, but ketp
            # here for future improments on the Cassandra BOSH Release.
            - 10.165.0.92=DC1:RAC1
            - 10.165.0.93=DC1:RAC1
            - 10.165.0.94=DC1:RAC1
            - 10.165.0.95=DC1:RAC1
    stemcell: *trusty_stemcell
    vm_type: &cassandra_vm_type large
    persistent_disk_type: &cassandra_persistent_disk_type small
    env:
      persistent_disk_fs: xfs
      bosh: { swap_size: 0 }
    networks: 
      - name: cassandra-net

  - name: cassandra-servers
    instances: *number_of_non_seeds_nodes
    azs: [z1]
    jobs:
      - name: cassandra
        release: *cassandra_release
        provides: 
          cassandra: { as: &cassandra_servers_link cassandra_servers_list }
        consumes:
          seeds: { from: *cassandra_seeds_link }          
        properties: *cassandra_properties
    stemcell: *trusty_stemcell
    vm_type: *cassandra_vm_type
    persistent_disk_type: *cassandra_persistent_disk_type
    env:
      persistent_disk_fs: xfs
      bosh: { swap_size: 0 }
    networks: 
      - name: cassandra-net

  - name: acceptance-tests
    release: *cassandra_release
    lifecycle: errand
    azs: [z1]
    instances: 1
    jobs:
      - name: cassandra-acceptance-tests
        consumes:
          cassandra_seeds_list: { from: *cassandra_seeds_link }
          cassandra_servers_list: { from: *cassandra_servers_link  }   
        release: *cassandra_release
        properties:
          cassandra_test_suite: ["crud"]
    vm_type: small
    stemcell: trusty
    networks: 
      - name: cassandra-net

variables:
  - name: cassandra_admin_password
    type: password
  - name: /internalCA
    type: certificate
    options:
      is_ca: true
      common_name: internalCA
  - name: cassandra_certificate_seeds
    type: certificate
    options:
      ca: /internalCA
      common_name: <%= seed.instance.address %>
      alternative_names: 
        - "*.cassandra-seeds.default.cassandra.bosh"
      extended_key_usage: [ client_auth, server_auth ]
  - name: cassandra_certificate_servers
    type: certificate
    options:
      ca: /internalCA
      common_name: <%= cluster.instance.address %>
      alternative_names: 
        - "*.cassandra-servers.default.cassandra.bosh"
      extended_key_usage: [ client_auth, server_auth ]
  - name: cassandra_key_store_pass  
    type: password


update:
  serial: true # instance groups to be deployed sequentially.

  canaries: 1
  canary_watch_time: 30000-240000
  # We don't support values >= 2 for 'max_in_flight'. Indeed there can
  # be a race condition in post-start when 2 repair-table are executed
  # in parallel.
  max_in_flight: 1
  update_watch_time: 30000-240000

stemcells:
  - alias: &trusty_stemcell trusty
    os: ubuntu-trusty
    version: latest
